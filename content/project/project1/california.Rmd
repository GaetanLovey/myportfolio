# Analysis of solar and hydroelectric power generation in California

In this part we will analyse the load curves in photovoltaic and hydraulic production. We will demonstrate the differences in power between these two energies and their behaviour. 

Finally, we aim to build a model that simulates power generation capacity from 2012 to 2018 and thus predict the total production. 

## Solar analysis

Photovoltaic panels are highly dependent on climatic factors. We will therefore see a significant seasonality on a daily and annual level.

### Annual and monthly solar production 

For the annual solar production, in Figure \@ref(fig:solar), we see an upward trend and a significant seasonality. The blue curve represents the average power per hour and the red curve the maximum power reached. For the months, we also notice a trend. Indeed, the total power is stronger in summer. 

Finally, we can see the great volatility of solar energy. The difference between maximum and average power is significant. This is the main characteristic of renewable energies. It is also what makes their production difficult to estimate. 

```{r solar, fig.cap="California solar capacity", echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=11, out.width = '70%'}
#Solar analysis
solar <- all_breakdown %>%
  select(ID_hour, ID_day, ID_month, ID_year, ID_date, `SOLAR PV`) %>%
  drop_na()

#All_period
solar_all <- solar %>%
  group_by(ID_date) %>%
  summarise(mean_solar_mW = mean(`SOLAR PV`)) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  mutate(ID_month = month(anydate(ID_date))) %>%
  mutate(ID_year = year(anydate(ID_date)))

#Rounding the day with a value = 0
solar_all$mean_solar_mW <-
  ifelse(solar_all$mean_solar_mW == 0,
         lag(solar_all$mean_solar_mW),
         solar_all$mean_solar_mW
  )
#By month
solar_month <- solar %>%
  group_by(ID_month) %>%
  summarise(mean_solar_mW = mean(`SOLAR PV`)) %>%
  mutate_if(is.numeric, round, digits = 3)

#By hour
solar_hour <- solar %>%
  group_by(ID_hour) %>%
  summarise(mean_power = mean(`SOLAR PV`)) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  rename(mean_SOLAR_MW = mean_power)

#Modelling part
solar_trend <- solar %>%
  group_by(ID_date) %>%
  summarize(max = max(`SOLAR PV`, na.rm = TRUE),
            mean = mean(`SOLAR PV`, na.rm = TRUE)) %>%
  pivot_longer(max:mean)

p1 <- solar_trend %>%
  ggplot(aes(x = ID_date)) +
  geom_line(aes(y = value, color = name)) +
  labs(x = "",
       y = "Power [mW]",
       color = "Power installed")

p2 <- solar_all %>%
  group_by(ID_month) %>%
  summarize(
    max = max(mean_solar_mW, na.rm = TRUE),
    min = min(mean_solar_mW, na.rm = TRUE),
    mean = mean(mean_solar_mW, na.rm = TRUE)
  ) %>%
  ggplot(aes(ID_month, mean)) +
  geom_pointrange(aes(ymin = min, ymax = max)) +
  labs(x = "Month",
       y = "Power [mW]") +
  scale_x_continuous(breaks = seq(1, 12, by = 1))
  

figure <- ggarrange(p1,
                    p2,
                    labels = c("A", "B"),
                    ncol = 1,
                    nrow = 2)

annotate_figure(
  figure,
  top = text_grob(
    "California solar capacity",
    color = "black",
    face = "bold",
    size = 14
  ),
  bottom = text_grob(
    "The range of the solar capacity by month. The dot represents the mean",
    color = "black",
    face = "bold",
    size = 14
  )
)

```

### Solar model
Our model is designed to estimate the average power per hour of the Californian photovoltaic park. 

We estimate the power with the model below. 
```{r message=FALSE, warning=FALSE}
model_solar <-
  lm(mean_solar_mW ~ I(ID_year - 2012) + ID_month, data = solar_all)
```

In the Table \@ref(tab:solar-summary), we see the estimated coefficients, the standard deviations and the p.values.

The second coefficient is positive. Each additional year, the power increases by 525.5 mW. Finally, concerning the coefficient of the months, each additional month adds 26.9mW.

```{r solar-summary, echo=FALSE, message=FALSE, warning=FALSE}
model_solar %>%
  tidy() %>%
  select(-statistic) %>%
  mutate(p.value = paste(round(p.value, 4), pval_star(p.value))) %>%
  kable(
    caption = "Summary of the model_solar",
    digits = 3,
    col.names = c("Parameter", "Estimate", "Standard Error", "P.value")
  ) %>%
  kable_styling(bootstrap_options = "striped")
```

We clearly see that our model does not take into account the strong seasonality effect but only the upward trend. 

```{r solar-model, echo=FALSE, fig.cap="California solar capacity (model)", message=FALSE, warning=FALSE, fig.height=10, fig.width=11, out.width = '70%'}

month_solar_pred <- solar_all %>%
  add_predictions(model_solar, var = "prediction")

yearly_pred <- month_solar_pred %>%
  group_by(ID_year) %>%
  summarize(prediction = mean(prediction)) 

p3 <- solar_trend %>%
  ggplot(aes(x = ID_date)) +
  geom_line(aes(y = value, color = name)) +
  geom_smooth(
    data = month_solar_pred,
    mapping = aes(x = ID_date, y = prediction, color = "model_predict"),
    size = 1
  ) +
  labs(x = "",
       y = "Power [mW]",
       color = "Power installed")

month_solar_pred <- month_solar_pred %>%
  group_by(ID_month) %>%
  summarise(avg_month = mean(prediction))
  
p4 <- p2 +
  geom_point(data = month_solar_pred,
             aes(x = ID_month, y = avg_month, color  = "predicted power")) +
  labs(color = "Power installed")

figure2 <- ggarrange(p3,
                     p4,
                     labels = c("A", "B"),
                     ncol = 1,
                     nrow = 2)

annotate_figure(
  figure2,
  top = text_grob(
    "California solar capacity (model)",
    color = "black",
    face = "bold",
    size = 14
  ),
  bottom = text_grob(
    "The range of the solar capacity by month. The dot represents the mean",
    color = "black",
    face = "bold",
    size = 14
  )
)
```

However, we can estimate the average production for the years in which the data were complete. In fact, by multiplying the average hourly power by 8760 hours, we obtain the total production in TWh. 

### Total solar production 
```{r echo=FALSE, message=FALSE, warning=FALSE}
solar_all %>%
  add_predictions(model_solar, var = "prediction") %>%
  group_by(ID_year) %>%
  summarise(
    avg_daily_power = mean(mean_solar_mW),
    avg_daily_power_pred = mean(prediction)
  ) %>%
  transmute(
    ID_year,
    yearly_pred_tWh = avg_daily_power_pred * 8760 / 1000000,
    yearly_tWh = avg_daily_power * 8760 / 1000000
  ) %>%
  filter(between(ID_year, 2015, 2017)) %>%
  kable(
    caption = "Total solar generation [tWh]",
    digits = 3,
    col.names = c("Year", "Predicted generation ", "Observed generation")
  ) %>%
  kable_styling(bootstrap_options = "striped")

```


### Power analysis per hour

```{r echo=FALSE, message=FALSE, warning=FALSE}
solar_hour_model <- solar %>%
  group_by(ID_date, ID_hour) %>%
  summarise(mean_solar_mW = mean(`SOLAR PV`)) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  mutate(ID_month = month(anydate(ID_date))) %>%
  mutate(ID_year = year(anydate(ID_date)))

solar_hour_model$ID_hour <-
  as.numeric(as.character(solar_hour_model$ID_hour))
``` 

We estimate the power with the model below which is a polynomial of order 6.
```{r message=FALSE, warning=FALSE}
hour_model_solar <- lm(formula = mean_solar_mW ~ poly(ID_hour, degree = 6),data= solar_hour_model)
```

As we can see from the p.values column, all the coefficients are significant. 
```{r echo=FALSE, message=FALSE, warning=FALSE}
hour_model_solar %>%
  tidy() %>%
  mutate(signif = stars.pval(p.value)) %>%
  kable(
    caption = "Summary of the model predicting power per hour",
    col.names = c(
      "Coefficient",
      "Estimate",
      "Std. Error",
      "t-statistic",
      "P.value",
      "Significance"
    )
  ) %>%
  kable_styling(bootstrap_options = "striped",
                full_width = FALSE)
```

From 8:00 p.m. to 5:00 a.m., the power is obviously almost zero. During the day, the power of the solar panels has a very high volatility. This is one of the characteristics of renewable energies such as solar or wind power. They are highly dependent on climatic conditions. 

However, our model fits the average hourly power pretty well. 
```{r echo = FALSE, message=FALSE, warning=FALSE}
predictions <-
  data_grid(solar_hour_model, ID_hour, .model = hour_model_solar) %>%
  add_predictions(hour_model_solar)

predictions <- predictions %>%
  group_by(ID_hour) %>%
  summarise(avg_pred = mean(pred))

solar_hour_model %>%
  group_by(ID_hour) %>%
  summarize(
    max = max(mean_solar_mW, na.rm = TRUE),
    min = min(mean_solar_mW, na.rm = TRUE),
    mean = mean(mean_solar_mW, na.rm = TRUE)
  )  %>%
  ggplot(aes(ID_hour, mean)) +
  geom_pointrange(aes(ymin = min, ymax = max)) +
  labs(
    x = "Hour",
    y = "Power [mW]",
    title = "Hourly capacity of the Californian photovoltaic park",
    subtitle = "The range of the solar capacity by month. The dot represents the mean"
  ) +
  geom_point(data = predictions, aes(ID_hour, avg_pred), color = "red")

```

## Small hydro analysis

### Annual and monthly solar production 

For the annual small hydro production, we can see that production varies a lot from year to year. However, there is still an annual seasonality. The blue curve represents the average power per hour and the red curve the maximum power reached. For the months, we also notice a trend. Indeed, the total power is stronger in summer. 

Finally, we can demonstrate that power has a low volatility. The difference between maximum and average power is small. 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=11, out.width = '70%'}
#Hydro analysis
hydro <- all_breakdown %>% 
  select(ID_hour,ID_day,ID_month,ID_year,ID_date, `SMALL HYDRO`) %>% 
  drop_na()

#All_period
hydro_all <- hydro %>% 
  group_by(ID_date) %>% 
  summarise(mean_hydro_mW= mean(`SMALL HYDRO`)) %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  mutate(ID_month = month(anydate(ID_date))) %>% 
  mutate(ID_year = year(anydate(ID_date)))

#Rounding the day with a value = 0
hydro_all$mean_hydro_mW <-
  ifelse(
    hydro_all$mean_hydro_mW == 0,
    lag(hydro_all$mean_hydro_mW),
    hydro_all$mean_hydro_mW
  )
#By month
solar_month <- hydro %>% 
  group_by(ID_month) %>% 
  summarise(mean_hydro_mW= mean(`SMALL HYDRO`)) %>% 
  mutate_if(is.numeric, round, digits = 3)

#By hour
hydro_hour <- hydro %>% 
  group_by(ID_hour) %>% 
  summarise(mean_power = mean(`SMALL HYDRO`)) %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  rename(mean_hydro_MW = mean_power)

#Modelling part
hydro_trend <- hydro %>%
  group_by(ID_date) %>%
  summarize(
    max = max(`SMALL HYDRO`, na.rm = TRUE),
    mean = mean(`SMALL HYDRO`, na.rm = TRUE)
  ) %>%
  pivot_longer(max:mean)

h1 <- hydro_trend %>%
  ggplot(aes(x = ID_date)) +
  geom_line(aes(y = value, color = name)) +
  labs(
    x = "",
    y = "Power [mW]",
    color = "Power installed"
  )

h2 <- hydro_all %>%
  group_by(ID_month) %>%
  summarize(
    max = max(mean_hydro_mW, na.rm = TRUE),
    min = min(mean_hydro_mW, na.rm = TRUE),
    mean = mean(mean_hydro_mW, na.rm = TRUE)
  ) %>% 
  ggplot(aes(ID_month, mean)) +
  geom_pointrange(aes(ymin = min, ymax = max)) +
  labs(
    x = "Month",
    y = "Power [mW]"
  ) +
  scale_x_continuous(breaks = seq(1,12, by =1))
  
figureh <- ggarrange(h1,
                     h2,
                     labels = c("A", "B"),
                     ncol = 1,
                     nrow = 2)

annotate_figure(
  figureh,
  top = text_grob(
    "California small hydro capacity",
    color = "black",
    face = "bold",
    size = 14
  ),
  bottom = text_grob(
    "The range of the small hydrolic capacity by month. The dot represents the mean",
    color = "black",
    face = "bold",
    size = 14
  )
)
```

In the Table \@ref(tab:model-hydro), we see the estimated coefficients, the standard deviations and the p.values.

The second coefficient is negative. Each additional year, the power decreases by -6.02 mW. Finally concerning the coefficient of the months, each additional month reduces the power by -7.59 mW.
```{r model-hydro,echo=FALSE, message=FALSE, warning=FALSE}
#Building model 
model_hydro <- lm(mean_hydro_mW ~ I(ID_year - 2012) + ID_month, data = hydro_all)

model_hydro %>%
  tidy() %>%
  select(-statistic) %>%
  mutate(p.value = paste(round(p.value, 4), pval_star(p.value))) %>%
  kable(
    caption = "Summary of the model_hydro",
    digits = 3,
    col.names = c("Parameter", "Estimate", "Standard Error", "P.value")
  ) %>%
  kable_styling(bootstrap_options = "striped")
```

We clearly see that our model does not take into account the strong seasonality effect.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=11, out.width = '70%'}

month_hydro_pred <- hydro_all %>%
  add_predictions(model_hydro, var = "prediction")

yearly_pred <- month_hydro_pred %>%
  group_by(ID_year) %>%
  summarize(prediction = mean(prediction)) 

h3 <- hydro_trend %>%
  ggplot(aes(x = ID_date)) +
  geom_line(aes(y = value, color = name))+
  geom_smooth(data = month_hydro_pred, mapping = aes(x=ID_date,y = prediction, color ="model_predict"), size = 1)+
    labs(
    x = "",
    y = "Power [mW]",
    color = "Power installed"
  )

month_hydro_pred <- month_hydro_pred %>% 
  group_by(ID_month) %>% 
  summarise(avg_month = mean(prediction))
  
h4 <- h2 + 
  geom_point(
    data = month_hydro_pred,
    aes(x = ID_month, y= avg_month, color  = "predicted power")
  ) + 
  labs(color = "Power installed")

figure2h <- ggarrange(h3, h4,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)

annotate_figure(figure2h,
               top = text_grob("California small hydro capacity", color = "black", face = "bold", size = 14),
  bottom = text_grob(
    "The range of the small hydrolic capacity by month. The dot represents the mean",
    color = "black",
    face = "bold",
    size = 14
  ))
```

### Power analysis per hour

```{r echo=FALSE, message=FALSE, warning=FALSE}
hydro_hour_model <- hydro %>% 
  group_by(ID_date, ID_hour) %>% 
  summarise(mean_hydro_mW= mean(`SMALL HYDRO`)) %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  mutate(ID_month = month(anydate(ID_date))) %>% 
  mutate(ID_year = year(anydate(ID_date))) 
```


We estimate the power with the model below which is a polynomial of order 6.

```{r message=FALSE, warning=FALSE}
hydro_hour_model$ID_hour <- as.numeric(as.character(hydro_hour_model$ID_hour))
```

As we can see from the p.values column, all the coefficients are significant.

```{r echo=FALSE, message=FALSE, warning=FALSE}
hour_model_hydro <- lm(formula = mean_hydro_mW ~ poly(ID_hour, degree = 6),data= hydro_hour_model)

hour_model_hydro %>%
    tidy() %>%
    mutate(signif = stars.pval(p.value)) %>%
    kable(
        caption = "Summary of the model predicting power per hour",
        col.names = c("Coefficient", "Estimate", "Std. Error", "t-statistic",
                      "P.value", "Significance")
    ) %>%
    kable_styling(
        bootstrap_options = "striped",
        full_width = FALSE
    )
```

The power of the small hydro is constant throughout the day. This is the major difference with renewable energy (solar or wind). 

Our model fits the average hourly power pretty well. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
predictions <- data_grid(hydro_hour_model, ID_hour, .model = hour_model_hydro) %>%
    add_predictions(hour_model_hydro)

predictions <- predictions %>% 
  group_by(ID_hour) %>% 
  summarise(avg_pred = mean(pred))

hydro_hour_model %>%
  group_by(ID_hour) %>%
  summarize(
    max = max(mean_hydro_mW, na.rm = TRUE),
    min = min(mean_hydro_mW, na.rm = TRUE),
    mean = mean(mean_hydro_mW, na.rm = TRUE)
  )  %>% 
  ggplot(aes(ID_hour, mean)) +
  geom_pointrange(aes(ymin = min, ymax = max)) +
  labs(
    x = "Hour",
    y = "Power [mW]",
    title = "Hourly capacity of the Californian small hydro",
    subtitle = "The range of the small hydro capacity by month. The dot represents the mean"
  ) +
  geom_point(data = predictions, aes(ID_hour, avg_pred), color = "red")
```

## The limits of our model 

Our series are not stationary. We should therefore have applied a model that takes seasonality into account. In order to deepen this analysis and to better predict the load curves, it would be interesting to apply an ARIMA model for example or exponential smoothing techniques.

In addition, in order to predict the future production of solar and wind power, it is essential to collect external weather data. However, we can already demonstrate the behaviour of the different load curves regarding the type of energy. 

On the one hand, renewable energies will be very volatile and therefore more difficult to predict (solar, wind). On the other hand, traditional energies (coal, gas and hydraulic) are not very volatile and therefore more easily predictable. 