# Wrangling 

Our data are composed by four databases: 

1. `electricity_state_info` brings us all the information about electricity in each state of US. Those information are dated from 2002 to 2018. 

2. `generation_state`is a database containing the type of producer, the energy source and the quantity of electricity generation (in Megawatthours) from 1990 to 2018. 

3. `state_info` is giving us all the econonomic aspects and other characteristics of each American state. 

4. `all_breakdown`provides all information about the power production from various power sources such as geothermal, biomass, biogas, hydro, wind and solar energy.

```{r message=FALSE, warning=FALSE}
electricity_state_info <- read_excel(here("data/electricity_state_info.xlsx"))

state_info <- read_excel(here("data/STATE_info.xls"))

generation_state <- read_excel(here("data/annual_generation_state.xls"))

all_breakdown <- read_csv(here("data/all_breakdown.csv"))
```

First, we need to clean those different databases.

In `state_info` and in `electricity_state_info`, we remove the dot at the beginning of each observation of the variable "state". Then, we create a new variable in `electricity_state_info`that will tell us if the state is energy self-sufficient. 


```{r warning=FALSE, message=FALSE, echo=FALSE}
#Cleaning the data base state_info. Removing the dot in each state. 
state_info <-  state_info %>%
  transmute(
    state = sub("\\.", "", state),
    region,
    year,
    population,
    area,
    density,
    house_unit,
    capita_house,
    GDP,
    capita_GDP,
    personal_income,
    summer_temp,
    winter_temp,
    Summer,
    winter,
    hours_sun
  )

#Creating a variable in order to know whether a state is self-sufficient in energy
electricity_state_info <-  electricity_state_info %>%
  mutate(autosuf = ifelse(Total_generation - Total_compsum_MWh >= 0, 1, 0))

#Cleaning the database electricity_state_info. Removing the dot in each state.
electricity_state_info <-  electricity_state_info %>%
  transmute(
    Year,
    State = sub("\\.", "", State),
    Residential_cust,
    Commercial_cust,
    Industrial_cust,
    Total_cust,
    price_cents_kwh,
    Total_compsum_MWh,
    Total_generation,
    autosuf
  )

```

In the table `generation_state`, there are only state abbreviations so we transform it into names and we add the region relative to the state. 

```{r warning=FALSE, message=FALSE, echo=FALSE}
generation_state <-  generation_state %>%
  transmute(
    Year = YEAR,
    state = recode(
      STATE,
      "AK" = "Alaska",
      "AL" = "Alabama",
      "AZ" = "Arizona",
      "AR" = "Arkansas",
      "CA" = "California",
      "CO" = "Colorado",
      "CT" = "Connecticut",
      "DE" = "Delaware",
      "FL" = "Florida",
      "GA" = "Georgia",
      "HI" = "Hawaii",
      "ID" = "Idaho",
      "IL" = "Illinois",
      "IN" = "Indiana",
      "IA" = "Iowa",
      "KS" = "Kansas",
      "KY" = "Kentucky",
      "LA" = "Louisiana",
      "ME" = "Maine",
      "MD" = "Maryland",
      "MA" = "Massachusetts",
      "MI" = "Michigan",
      "MN" = "Minnesota",
      "MS" = "Mississippi",
      "MO" = "Missouri",
      "MT" = "Montana",
      "NE" = "Nebraska",
      "NV" = "Nevada",
      "NH" = "New Hampshire",
      "NJ" = "New Jersey",
      "NM" = "New Mexico",
      "NY" = "New York",
      "NC" = "North Carolina",
      "ND" = "North Dakota",
      "OH" = "Ohio",
      "OK" = "Oklahoma",
      "OR" = "Oregon",
      "PA" = "Pennsylvania",
      "RI" = "Rhode Island",
      "SD" = "South Dakota",
      "TN" = "Tennessee",
      "TX" = "Texas",
      "UT" = "Utah",
      "VT" = "Vermont",
      "VA" = "Virginia",
      "WA" = "Washington",
      "WV" = "West Virginia",
      "WI" = "Wisconsin",
      "WY" = "Wyoming",
      "DC" = "District of Columbia",
      "SC" = "South Carolina"
    ),
    region = recode(
      state,
      "Alaska" = "West Pacific",
      "Alabama" = "East South Central",
      "Arizona" = "West Mountain",
      "Arkansas" = "West South Central",
      "California" = "West Pacific",
      "Colorado" = "West Mountain",
      "Connecticut" = "New England",
      "Delaware" = "South Atlantic",
      "Florida" = "South Atlantic",
      "Georgia" = "South Atlantic",
      "Hawaii" = "West Pacific",
      "Idaho" = "West Mountain",
      "Illinois" = "East North Central",
      "Indiana" = "East North Central",
      "Iowa" = "West North Central",
      "Kansas" = "West North Central",
      "Kentucky" = "East South Central",
      "Louisiana" = "West South Central",
      "Maine" = "New England",
      "Maryland" = "South Atlantic",
      "Massachusetts" = "New England",
      "Michigan" = "East North Central",
      "Minnesota" = "West North Central",
      "Mississippi" = "East South Central",
      "Missouri" = "West North Central",
      "Montana" = "West Mountain",
      "Nebraska" = "West North Central",
      "Nevada" = "West Mountain",
      "New Hampshire" = "New England",
      "New Jersey" = "Middle Atlantic",
      "New Mexico" = "West Mountain",
      "New York" = "Middle Atlantic",
      "North Carolina" = "South Atlantic",
      "North Dakota" = "West North Central",
      "Ohio" = "East North Central",
      "Oklahoma" = "West South Central",
      "Oregon" = "West Pacific",
      "Pennsylvania" = "Middle Atlantic",
      "Rhode Island" = "New England",
      "South Dakota" = "West North Central",
      "Tennessee" = "East South Central",
      "Texas" = "West South Central",
      "Utah" = "West Mountain",
      "Vermont" = "New England",
      "Virginia" = "South Atlantic",
      "Washington" = "West Pacific",
      "West Virginia" = "South Atlantic",
      "Wisconsin" = "East North Central",
      "Wyoming" = "West Mountain",
      "District of Columbia" = "South Atlantic",
      "South Carolina" = "South Atlantic"
    ),
    Type_of_Producer = `TYPE OF PRODUCER`,
    Energy_Source = `ENERGY SOURCE`,
    Generation_mWh = `GENERATION (Megawatthours)`
  )

```

We also add the region relative to each state in the `electricity_state_info` table. 


```{r warning=FALSE, message=FALSE, echo=FALSE}
#Adding region to electricity_state_info
electricity_state_info <- electricity_state_info %>%
  transmute(
    Year,
    State,
    region = recode(
      State,
      "Alaska" = "West Pacific",
      "Alabama" = "East South Central",
      "Arizona" = "West Mountain",
      "Arkansas" = "West South Central",
      "California" = "West Pacific",
      "Colorado" = "West Mountain",
      "Connecticut" = "New England",
      "Delaware" = "South Atlantic",
      "Florida" = "South Atlantic",
      "Georgia" = "South Atlantic",
      "Hawaii" = "West Pacific",
      "Idaho" = "West Mountain",
      "Illinois" = "East North Central",
      "Indiana" = "East North Central",
      "Iowa" = "West North Central",
      "Kansas" = "West North Central",
      "Kentucky" = "East South Central",
      "Louisiana" = "West South Central",
      "Maine" = "New England",
      "Maryland" = "South Atlantic",
      "Massachusetts" = "New England",
      "Michigan" = "East North Central",
      "Minnesota" = "West North Central",
      "Mississippi" = "East South Central",
      "Missouri" = "West North Central",
      "Montana" = "West Mountain",
      "Nebraska" = "West North Central",
      "Nevada" = "West Mountain",
      "New Hampshire" = "New England",
      "New Jersey" = "Middle Atlantic",
      "New Mexico" = "West Mountain",
      "New York" = "Middle Atlantic",
      "North Carolina" = "South Atlantic",
      "North Dakota" = "West North Central",
      "Ohio" = "East North Central",
      "Oklahoma" = "West South Central",
      "Oregon" = "West Pacific",
      "Pennsylvania" = "Middle Atlantic",
      "Rhode Island" = "New England",
      "South Dakota" = "West North Central",
      "Tennessee" = "East South Central",
      "Texas" = "West South Central",
      "Utah" = "West Mountain",
      "Vermont" = "New England",
      "Virginia" = "South Atlantic",
      "Washington" = "West Pacific",
      "West Virginia" = "South Atlantic",
      "Wisconsin" = "East North Central",
      "Wyoming" = "West Mountain",
      "District of Columbia" = "South Atlantic",
      "South Carolina" = "South Atlantic"
    ),
    Residential_cust,
    Commercial_cust,
    Industrial_cust,
    Total_cust,
    price_cents_kwh,
    Total_compsum_MWh,
    Total_generation,
    autosuf
  )
```

Again, we do the same operation to the `state_info` database. 

```{r warning=FALSE, message=FALSE, echo=FALSE}
#Adding region to state_info
state_info <- state_info %>%
  transmute(
    year,
    state,
    region = recode(
      state,
      "Alaska" = "West Pacific",
      "Alabama" = "East South Central",
      "Arizona" = "West Mountain",
      "Arkansas" = "West South Central",
      "California" = "West Pacific",
      "Colorado" = "West Mountain",
      "Connecticut" = "New England",
      "Delaware" = "South Atlantic",
      "Florida" = "South Atlantic",
      "Georgia" = "South Atlantic",
      "Hawaii" = "West Pacific",
      "Idaho" = "West Mountain",
      "Illinois" = "East North Central",
      "Indiana" = "East North Central",
      "Iowa" = "West North Central",
      "Kansas" = "West North Central",
      "Kentucky" = "East South Central",
      "Louisiana" = "West South Central",
      "Maine" = "New England",
      "Maryland" = "South Atlantic",
      "Massachusetts" = "New England",
      "Michigan" = "East North Central",
      "Minnesota" = "West North Central",
      "Mississippi" = "East South Central",
      "Missouri" = "West North Central",
      "Montana" = "West Mountain",
      "Nebraska" = "West North Central",
      "Nevada" = "West Mountain",
      "New Hampshire" = "New England",
      "New Jersey" = "Middle Atlantic",
      "New Mexico" = "West Mountain",
      "New York" = "Middle Atlantic",
      "North Carolina" = "South Atlantic",
      "North Dakota" = "West North Central",
      "Ohio" = "East North Central",
      "Oklahoma" = "West South Central",
      "Oregon" = "West Pacific",
      "Pennsylvania" = "Middle Atlantic",
      "Rhode Island" = "New England",
      "South Dakota" = "West North Central",
      "Tennessee" = "East South Central",
      "Texas" = "West South Central",
      "Utah" = "West Mountain",
      "Vermont" = "New England",
      "Virginia" = "South Atlantic",
      "Washington" = "West Pacific",
      "West Virginia" = "South Atlantic",
      "Wisconsin" = "East North Central",
      "Wyoming" = "West Mountain",
      "District of Columbia" = "South Atlantic",
      "South Carolina" = "South Atlantic"
    ),
    population,
    area,
    density,
    house_unit,
    capita_house,
    GDP,
    capita_GDP,
    personal_income,
    summer_temp,
    winter_temp,
    Summer,
    winter,
    hours_sun
  )

```

We create a new dataframe which is the jointure between `state_info` and `electricity_state_info` in order to have all economic, social and energy information per state.

```{r warning=FALSE, message=FALSE, echo=FALSE} 
state_info <- rename(state_info, "State" = state, "Year" = year)

jointure <-
  merge(
    electricity_state_info,
    state_info,
    all.x = TRUE,
    by = c("State", "Year")
  )

jointure <- jointure[, -12]
```

In`all_breakdown`, we add new columns such as the year, the month, the day  and the hour of the observations. 

```{r warning=FALSE, message=FALSE, echo=FALSE}
all_breakdown <- all_breakdown %>% 
  mutate(ID_day = day(anydate(TIMESTAMP))) %>%
  mutate(ID_month = month(anydate(TIMESTAMP))) %>%
  mutate(ID_year = year(anydate(TIMESTAMP))) 

hour = format(as.POSIXct(all_breakdown$TIMESTAMP,format="Y%:M%:D% %H:%M"),"%H")

all_breakdown <- all_breakdown %>% 
  mutate(ID_hour = hour)

#Creating a key named "ID_date"
date <-
  with(all_breakdown, ymd(paste(ID_year, ID_month, ID_day,  sep = ' ')))

all_breakdown <- all_breakdown %>%
  mutate(ID_date = date)

```

